# scp2

scp (real) over ssh

适用于真的禁止了 scp 协议, 只开放 ssh 协议的场景

## Why

if only ssh is enable and scp/sftp disabled

## Usage

```bash
scp2 -f ./scp2/core.py -u user@IP:~/core.py
```

## How

如果真的只让有 ssh, 那么就用输入命令的方式来传输信息

write the file into command

1. `file` --> `base64` --> `chunk` --> `ssh.execute(echo "[chunk body]" >> /tmpfile)`

2. `ssh.execute(cat /tmpfile |tr -d '\n'|base64 -d > dest)`


It's real scp over the ssh.


### Example

```bash
scp2 -f ./scp2/core.py -u user@IP:~/core.py
```

the logs:

```
INFO:paramiko.transport:Connected (version 2.0, client OpenSSH_7.6p1)
INFO:paramiko.transport:Authentication (publickey) successful!
INFO:root:will temp write to /tmp/94d45061-5f4c-4bc4-9282-d60041952caf
INFO:root:echo "aW1wb3J0IGJhc2U2NAppbXBvcnQgaW8KaW1wb3J0IGxvZ2dpbmcKaW1wb3J0IHV1aWQKCmltcG9ydCBjbGljawppbXBvcnQgbW9yZV9pdGVydG9vbHMKaW1wb3J0IHBhcmFtaWtvCgoKZGVmIG5ld19zc2hfY29ubihob3N0LCBwb3J0LCB1c2VyKToKICAgIHNzaCA9IHBhcmFtaWtvLlNTSENsaWVudCgpCiAgICBzc2guc2V0X21pc3NpbmdfaG9zdF9rZXlfcG9saWN5KHBhcmFtaWtvLkF1dG9BZGRQb2xpY3koKSkKICAgIHNzaC5jb25uZWN0KGhvc3QsIHBvcnQsIHVzZXIpCiAgICByZXR1cm4gc3NoCgoKZGVmIGZpbGVfdG9fNjQoZmlsZSk6CiAgICB3aXRoIGlvLm9wZW4oZmlsZSwgJ3JiJykgYXMgZjoKICAgICAgICByYXdfY29udGVudCA9IGYucmVhZCgpCiAgICBiYXNlNjRfY29udGVudCA9IGJhc2U2NC5iNjRlbmNvZGUocmF3X2NvbnRlbnQpCiAgICBjb250ZW50ID0gYmFzZTY0X2NvbnRlbnQuZGVjb2RlKCd1dGY4JykKICAgIHJldHVybiBjb250ZW50CgoKZGVmIGNodW5rX3VwbG9hZF90bXAoc3NoX2Nvbm4sIHRtcGZpbGUsIGNvbnRlbnQsIGNodW5rc2l6ZT0xMDI0KToKICAgIGNodW5rZWQgPSBtb3JlX2l0ZXJ0b29scy5pY2h1bmtlZChjb250ZW50LCBjaHVua3NpemUpCiAgICBmb3IgYyBpbiBjaHVua2VkOgogICAgICAgIGNodW5rID0gJycuam9pbihjKQogICAgICAgIGNtZCA9IGYnZWNobyAie2NodW5rfSIgPj4ge3RtcGZpbGV9JwogICAgICAgIGxvZ2dpbmcuaW5mbyhjbWQpCgogICAgICAgIHNzaF9jb25uLmV4ZWNfY29tbWFuZChjbWQp" >> /tmp/94d45061-5f4c-4bc4-9282-d60041952caf
INFO:root:echo "CgoKZGVmIHJlYnVpbGRfZnJvbV90bXAoc3NoX2Nvbm4sIHRtcGZpbGUsIHRvZmlsZSk6CiAgICBjbWQgPSBmImNhdCB7dG1wZmlsZX18dHIgLWQgJ1xuJ3xiYXNlNjQgLWQgPiB7dG9maWxlfSIKICAgIGxvZ2dpbmcuaW5mbyhjbWQpCiAgICBzc2hfY29ubi5leGVjX2NvbW1hbmQoY21kKQoKICAgIGNtZCA9IGYicm0ge3RtcGZpbGV9IgogICAgbG9nZ2luZy5pbmZvKGNtZCkKICAgIHNzaF9jb25uLmV4ZWNfY29tbWFuZChjbWQpCgoKIyBUT0RPOiDlhbzlrrkgc2NwIOWRveS7pOino+aekAojICjkuZ/lj6/ku6XlsIbmnaXogIPomZHmnInkuIDlpZcgcHl0aG9uIOino+aekOaJgOaciSBsaW51eCBjbWQg55qEIGNvbW1vbiBjbGljay5oZWFkZXIgKQpAY2xpY2suY29tbWFuZCgpCkBjbGljay5vcHRpb24oJy1mJywgJy0tZmlsZScsICdmaWxlJywgcmVxdWlyZWQ9VHJ1ZSwgaGVscD0nc2VuZCBmaWxlIHNyYycpCkBjbGljay5vcHRpb24oJy11JywgJy0tdXJpJywgJ3VyaScsIHJlcXVpcmVkPVRydWUsIGhlbHA9J3RoZSB0YXJnZXQgZGVzdCcpCkBjbGljay5vcHRpb24oJy1wJywgJy0tcG9ydCcsICdwb3J0JywgZGVmYXVsdD0yMiwgaGVscD0naG9zdCBwb3J0JykKZGVmIHNjcDIoZmlsZSwgdXJpLCBwb3J0KToKICAgIGhlYWQsIHRvZmlsZSA9IHVyaS5zcGxpdCgnOicpCiAgICB1c2VyLCBob3N0ID0gaGVhZC5zcGxpdCgnQCcpCgogICAgY29udGVudCA9IGZpbGVfdG9fNjQoZmlsZSkKCiAgICBsb2dnaW5nLmJhc2ljQ29uZmlnKGxldmVsPWxvZ2dpbmcu" >> /tmp/94d45061-5f4c-4bc4-9282-d60041952caf
INFO:root:echo "SU5GTykKCiAgICBzc2hfY29ubiA9IG5ld19zc2hfY29ubihob3N0PWhvc3QsIHBvcnQ9cG9ydCwgdXNlcj11c2VyKQoKICAgIHRtcGZpbGUgPSBmJy90bXAve3V1aWQudXVpZDQoKX0nCiAgICBsb2dnaW5nLmluZm8oZid3aWxsIHRlbXAgd3JpdGUgdG8ge3RtcGZpbGV9JykKCiAgICBjaHVua191cGxvYWRfdG1wKHNzaF9jb25uLCB0bXBmaWxlLCBjb250ZW50KQogICAgcmVidWlsZF9mcm9tX3RtcChzc2hfY29ubiwgdG1wZmlsZSwgdG9maWxlKQoKICAgIGxvZ2dpbmcuaW5mbygndXBsb2FkIHN1Y2Nlc3MnKQoKCmlmIF9fbmFtZV9fID09ICdfX21haW5fXyc6CiAgICBzY3AyKCkK" >> /tmp/94d45061-5f4c-4bc4-9282-d60041952caf
INFO:root:cat /tmp/94d45061-5f4c-4bc4-9282-d60041952caf|tr -d '
'|base64 -d > ~/core.py
INFO:root:rm /tmp/94d45061-5f4c-4bc4-9282-d60041952caf
INFO:root:upload success
```

## TODO

1. real scp, dirs, empty resurive ( lib.gnu.coreutils.click.headers )
2. better log
3. base64 or ?
